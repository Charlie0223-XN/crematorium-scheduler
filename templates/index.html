<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <title>ç«è‘¬å ´æ’ç­ AIï¼ˆå¤šæ—¥ç‰ˆï¼‰</title>
    <style>
      body {
        font-family: "Microsoft JhengHei", sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      h1 {
        margin-bottom: 10px;
      }
      .control-panel,
      .result-panel,
      .stats-panel {
        background: #ffffff;
        padding: 16px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
      }
      .field-row {
        margin-bottom: 10px;
      }
      label {
        margin-right: 8px;
      }
      .days-container {
        margin-top: 10px;
      }
      .day-block {
        background: #fafafa;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 10px;
      }
      .day-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
        font-weight: bold;
      }
      .emp-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .emp-item {
        border: 1px solid #ccc;
        padding: 3px 6px;
        border-radius: 4px;
        background: #fff;
        font-size: 13px;
      }
      button {
        padding: 6px 12px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        background: #1976d2;
        color: #fff;
        font-size: 14px;
        margin-right: 8px;
      }
      button:disabled {
        background: #aaa;
        cursor: not-allowed;
      }
      .result-day {
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #ddd;
      }
      .result-day h3 {
        margin: 0 0 4px 0;
      }
      pre {
        white-space: pre-wrap;
        font-size: 13px;
        background: #f9f9f9;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #eee;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 13px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 6px 8px;
        text-align: center;
      }
      th {
        background: #f0f0f0;
      }
      .bad {
        color: #c62828;
        font-weight: bold;
      }
    </style>

    <!-- Chart.js for é›·é”åœ– -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <h1>ğŸ”¥ ç«è‘¬å ´æ’ç­ AIï¼ˆå¤šæ—¥ç‰ˆï¼‰</h1>

    <div class="control-panel">
      <div class="field-row">
        <label for="start-date">èµ·å§‹æ—¥æœŸï¼š</label>
        <input type="date" id="start-date" />
        <label for="end-date" style="margin-left: 12px">çµæŸæ—¥æœŸï¼š</label>
        <input type="date" id="end-date" />
        <button type="button" onclick="buildDays()">å»ºç«‹æ—¥æœŸåˆ—è¡¨</button>
      </div>
      <div class="field-row">
        <small
          >èªªæ˜ï¼šå…ˆé¸èµ·å§‹èˆ‡çµæŸæ—¥æœŸ â†’ æŒ‰ã€Œå»ºç«‹æ—¥æœŸåˆ—è¡¨ã€â†’ æ¯å¤©å‹¾ä¸Šç­äººå“¡ï¼æ˜¯å¦ç¦ä¼‘æ—¥ï¼ˆå…¨å“¡ï¼‰ï¼æ˜¯å¦å¤§æ—¥ â†’
          æŒ‰ã€Œç”¢ç”Ÿæ•´æ®µæ’ç­ã€ã€‚</small
        >
      </div>

      <div id="days-container" class="days-container"></div>

      <div class="field-row">
        <button type="button" id="generate-btn" onclick="generateSchedule()" disabled>
          ç”¢ç”Ÿæ•´æ®µæ’ç­
        </button>
        <button type="button" id="export-btn" onclick="exportExcel()" disabled>
          ä¸‹è¼‰ Excel
        </button>
        <button type="button" id="stats-btn" onclick="renderStats()" disabled>
          æŸ¥çœ‹æ’ç­çµ±è¨ˆ
        </button>
      </div>
    </div>

    <div id="result-panel" class="result-panel" style="display: none">
      <h2>æ’ç­çµæœ</h2>
      <div id="result-content"></div>
    </div>

    <div id="stats-panel" class="stats-panel" style="display: none">
      <h2>çµ±è¨ˆèˆ‡é›·é”åœ–</h2>
      <p style="font-size: 13px">
        èªªæ˜ï¼š<br />
        ãƒ»A/B/C/D/E æ¬¡æ•¸ï¼šæ•´æ®µæ’ç­ä¸­å„è§’è‰²å‡ºç¾æ¬¡æ•¸ã€‚<br />
        ãƒ»å¤§æ—¥Dï¼šåœ¨æ¨™è¨˜ç‚ºå¤§æ—¥çš„æ—¥å­è£¡æ“”ä»» D çš„æ¬¡æ•¸ï¼ˆå£“åŠ›å¤§çš„å€¼ç­ï¼‰ã€‚<br />
        ãƒ»é€±ä¸€Cï¼šåœ¨é€±ä¸€æ“”ä»» C çš„æ¬¡æ•¸ï¼ˆå«ç‰¹æ®Šä»»å‹™ï¼‰ã€‚<br />
        ãƒ»é€£çºŒCï¼šæ˜¯å¦å‡ºç¾ C â†’ C çš„é•è¦æƒ…æ³ï¼ˆç†æƒ³æƒ…æ³æ‡‰è©²æ˜¯ 0ï¼‰ã€‚<br />
      </p>
      <canvas id="radarChart" width="400" height="300"></canvas>
      <div style="margin-top: 16px">
        <h3>è©³ç´°çµ±è¨ˆè¡¨</h3>
        <div id="stats-table-wrapper"></div>
      </div>
    </div>

    <script>
      // å¾å¾Œç«¯å¸¶ä¾†çš„å“¡å·¥åå–®
      const EMPLOYEES = {{ employees | tojson | safe }};
      const weekdayMap = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];

      // ä¸Šä¸€æ¬¡ç”¢ç”Ÿçš„æ’ç­çµæœ + æ—¥æœŸç¯„åœï¼ˆçµ¦åŒ¯å‡ºï¼çµ±è¨ˆç”¨ï¼‰
      window.lastSchedule = null;
      window.lastStartDate = "";
      window.lastEndDate = "";

      let radarChart = null;

      function parseDateInput(id) {
        const v = document.getElementById(id).value;
        if (!v) return null;
        return new Date(v + "T00:00:00");
      }

      function buildDays() {
        const start = parseDateInput("start-date");
        const end = parseDateInput("end-date");
        const container = document.getElementById("days-container");
        container.innerHTML = "";
        document.getElementById("result-panel").style.display = "none";
        document.getElementById("stats-panel").style.display = "none";
        document.getElementById("export-btn").disabled = true;
        document.getElementById("stats-btn").disabled = true;
        window.lastSchedule = null;

        if (!start || !end) {
          alert("è«‹å…ˆé¸æ“‡èµ·å§‹èˆ‡çµæŸæ—¥æœŸã€‚");
          return;
        }
        if (end < start) {
          alert("çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼èµ·å§‹æ—¥æœŸã€‚");
          return;
        }

        let current = new Date(start.getTime());
        let index = 1;

        while (current <= end) {
          const y = current.getFullYear();
          const m = (current.getMonth() + 1).toString().padStart(2, "0");
          const d = current.getDate().toString().padStart(2, "0");
          const w = weekdayMap[current.getDay()];
          const dateStr = `${y}-${m}-${d}`;

          const block = document.createElement("div");
          block.className = "day-block";
          block.dataset.date = dateStr;

          const header = document.createElement("div");
          header.className = "day-header";
          header.innerHTML = `
            <span>Day ${index}ï½œ${dateStr}ï¼ˆé€±${w}ï¼‰</span>
            <div>
              <label style="margin-right: 10px;">
                <input type="checkbox" class="bigday-toggle">
                å¤§æ—¥
              </label>
              <label>
                <input type="checkbox" class="full-staff-toggle">
                ç¦ä¼‘æ—¥ï¼ˆå…¨å“¡ä¸Šç­ï¼‰
              </label>
            </div>
          `;
          block.appendChild(header);

          const empList = document.createElement("div");
          empList.className = "emp-list";

          EMPLOYEES.forEach((name) => {
            const label = document.createElement("label");
            label.className = "emp-item";
            label.innerHTML = `
              <input type="checkbox" class="emp-checkbox" value="${name}">
              ${name}
            `;
            empList.appendChild(label);
          });

          block.appendChild(empList);
          container.appendChild(block);

          const fullToggle = block.querySelector(".full-staff-toggle");
          fullToggle.addEventListener("change", () => {
            const checkboxes = block.querySelectorAll(".emp-checkbox");
            checkboxes.forEach((cb) => {
              cb.checked = fullToggle.checked;
            });
          });

          const empCheckboxes = block.querySelectorAll(".emp-checkbox");
          empCheckboxes.forEach((cb) => {
            cb.addEventListener("change", () => {
              const allChecked = Array.from(empCheckboxes).every((x) => x.checked);
              fullToggle.checked = allChecked;
            });
          });

          current.setDate(current.getDate() + 1);
          index++;
        }

        if (index > 1) {
          document.getElementById("generate-btn").disabled = false;
        } else {
          document.getElementById("generate-btn").disabled = true;
        }
      }

      async function generateSchedule() {
        const container = document.getElementById("days-container");
        const blocks = container.querySelectorAll(".day-block");
        if (!blocks.length) {
          alert("è«‹å…ˆå»ºç«‹æ—¥æœŸåˆ—è¡¨ã€‚");
          return;
        }

        const payloadDays = [];

        blocks.forEach((block) => {
          const fullToggle = block.querySelector(".full-staff-toggle");
          const bigToggle = block.querySelector(".bigday-toggle");
          const empCheckboxes = block.querySelectorAll(".emp-checkbox");
          const dateStr = block.dataset.date;

          let emps = [];
          if (!fullToggle.checked) {
            empCheckboxes.forEach((cb) => {
              if (cb.checked) emps.push(cb.value);
            });
          }

          payloadDays.push({
            date: dateStr,
            big_day: bigToggle.checked,
            full_staff: fullToggle.checked,
            employees: emps,
          });
        });

        const resp = await fetch("/api/schedule_range", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ days: payloadDays }),
        });

        const data = await resp.json();
        const panel = document.getElementById("result-panel");
        const content = document.getElementById("result-content");

        if (!resp.ok || data.error) {
          panel.style.display = "block";
          content.innerHTML = `<p style="color:red;">éŒ¯èª¤ï¼š${data.error || "æœªçŸ¥éŒ¯èª¤"}</p>`;
          document.getElementById("export-btn").disabled = true;
          document.getElementById("stats-btn").disabled = true;
          return;
        }

        const schedule = data.schedule || [];
        window.lastSchedule = schedule;
        window.lastStartDate = document.getElementById("start-date").value;
        window.lastEndDate = document.getElementById("end-date").value;
        document.getElementById("export-btn").disabled = schedule.length === 0;
        document.getElementById("stats-btn").disabled = schedule.length === 0;

        let html = "";
        schedule.forEach((day) => {
          const dateStr = day.date || "";
          html += `<div class="result-day">`;
          html += `<h3>Day ${day.day_index}${
            dateStr ? " ï½œ " + dateStr : ""
          }</h3>`;
          html += `<pre>`;
          const assignment = day.assignment || {};
          for (const [name, pos] of Object.entries(assignment)) {
            html += `${name}ï¼š${pos}\n`;
          }
          html += `</pre>`;
          html += `</div>`;
        });

        panel.style.display = "block";
        content.innerHTML = html;
      }

      async function exportExcel() {
        if (!window.lastSchedule || !window.lastSchedule.length) {
          alert("è«‹å…ˆç”¢ç”Ÿæ’ç­ï¼Œå†ä¸‹è¼‰ Excelã€‚");
          return;
        }

        const startDate =
          window.lastStartDate || document.getElementById("start-date").value;
        const endDate =
          window.lastEndDate || document.getElementById("end-date").value;

        const resp = await fetch("/api/export_excel", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            schedule: window.lastSchedule,
            start_date: startDate,
            end_date: endDate,
          }),
        });

        if (!resp.ok) {
          alert("ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
          return;
        }

        const blob = await resp.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = ""; // æª”åç”±å¾Œç«¯ headers æ§åˆ¶
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      }

      function computeStats() {
        const stats = {};
        EMPLOYEES.forEach((name) => {
          stats[name] = {
            roles: { A: 0, B: 0, C: 0, D: 0, E: 0 },
            bigA: 0,
            bigD: 0,
            monC: 0,
            consecutiveC: 0,
          };
        });

        const lastRole = {};
        if (!window.lastSchedule) return stats;

        window.lastSchedule.forEach((day) => {
          const assignment = day.assignment || {};
          const weekday = day.weekday; // 0=Mon
          const isBig = !!day.big_day;

          EMPLOYEES.forEach((name) => {
            const role = assignment[name] || null;
            if (!role) {
              lastRole[name] = role;
              return;
            }

            if (!stats[name].roles[role]) {
              stats[name].roles[role] = 0;
            }
            stats[name].roles[role]++;

            if (isBig && role === "A") stats[name].bigA++;
            if (isBig && role === "D") stats[name].bigD++;

            if (weekday === 0 && role === "C" && name !== "åœ¨æ…¶" && name !== "å¥•å¿ ") {
              stats[name].monC++;
            }

            if (lastRole[name] === "C" && role === "C") {
              stats[name].consecutiveC++;
            }

            lastRole[name] = role;
          });
        });

        return stats;
      }

      function renderStats() {
        if (!window.lastSchedule || !window.lastSchedule.length) {
          alert("è«‹å…ˆç”¢ç”Ÿæ’ç­ï¼Œå†æŸ¥çœ‹çµ±è¨ˆã€‚");
          return;
        }

        const stats = computeStats();
        const panel = document.getElementById("stats-panel");
        panel.style.display = "block";

        // ---- 1. ç”¢ç”Ÿè¡¨æ ¼ ----
        let tableHtml = `
          <table>
            <thead>
              <tr>
                <th>å§“å</th>
                <th>A</th>
                <th>B</th>
                <th>C</th>
                <th>D</th>
                <th>E</th>
                <th>å¤§æ—¥A</th>
                <th>å¤§æ—¥D</th>
                <th>é€±ä¸€C</th>
                <th>é€£çºŒCé•è¦</th>
              </tr>
            </thead>
            <tbody>
        `;

        EMPLOYEES.forEach((name) => {
          const s = stats[name];
          tableHtml += "<tr>";
          tableHtml += `<td>${name}</td>`;
          tableHtml += `<td>${s.roles.A || 0}</td>`;
          tableHtml += `<td>${s.roles.B || 0}</td>`;
          tableHtml += `<td>${s.roles.C || 0}</td>`;
          tableHtml += `<td>${s.roles.D || 0}</td>`;
          tableHtml += `<td>${s.roles.E || 0}</td>`;
          tableHtml += `<td>${s.bigA}</td>`;
          tableHtml += `<td>${s.bigD}</td>`;
          tableHtml += `<td>${s.monC}</td>`;
          tableHtml += `<td class="${
            s.consecutiveC > 0 ? "bad" : ""
          }">${s.consecutiveC}</td>`;
          tableHtml += "</tr>";
        });

        tableHtml += "</tbody></table>";
        document.getElementById("stats-table-wrapper").innerHTML = tableHtml;

        // ---- 2. é›·é”åœ– ----
        const labels = ["A", "B", "C", "D", "E", "å¤§æ—¥D", "é€±ä¸€C"];

        const datasets = EMPLOYEES.map((name, idx) => {
          const s = stats[name];
          // ç°¡å–®é¡è‰²ï¼ˆä½ å¦‚æœä¹‹å¾Œè¦èª¿ä¹Ÿå¯ä»¥ï¼‰
          const hue = (idx * 40) % 360;
          const borderColor = `hsl(${hue}, 70%, 45%)`;
          const bgColor = `hsla(${hue}, 70%, 45%, 0.15)`;

          return {
            label: name,
            data: [
              s.roles.A || 0,
              s.roles.B || 0,
              s.roles.C || 0,
              s.roles.D || 0,
              s.roles.E || 0,
              s.bigD,
              s.monC,
            ],
            fill: true,
            borderColor: borderColor,
            backgroundColor: bgColor,
            pointRadius: 2,
          };
        });

        const ctx = document.getElementById("radarChart").getContext("2d");
        if (radarChart) {
          radarChart.destroy();
        }
        radarChart = new Chart(ctx, {
          type: "radar",
          data: {
            labels: labels,
            datasets: datasets,
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "top",
              },
            },
            scales: {
              r: {
                beginAtZero: true,
                ticks: {
                  precision: 0,
                },
              },
            },
          },
        });
      }
    </script>
  </body>
</html>
