<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>ç«è‘¬å ´æ’ç­ AIï¼ˆå¤šæ—¥ç‰ˆï¼‰</title>
  <style>
    body {
      font-family: "Microsoft JhengHei", sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      margin-bottom: 10px;
    }
    .control-panel, .result-panel {
      background: #ffffff;
      padding: 16px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }
    .field-row {
      margin-bottom: 10px;
    }
    label {
      margin-right: 8px;
    }
    .days-container {
      margin-top: 10px;
    }
    .day-block {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
      font-weight: bold;
    }
    .emp-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .emp-item {
      border: 1px solid #ccc;
      padding: 3px 6px;
      border-radius: 4px;
      background: #fff;
      font-size: 13px;
    }
    button {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      font-size: 14px;
      margin-right: 8px;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .result-day {
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #ddd;
    }
    .result-day h3 {
      margin: 0 0 4px 0;
    }
    pre {
      white-space: pre-wrap;
      font-size: 13px;
      background: #f9f9f9;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #eee;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: center;
    }
    th {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1>ğŸ”¥ ç«è‘¬å ´æ’ç­ AIï¼ˆå¤šæ—¥ç‰ˆï¼‰</h1>

  <div class="control-panel">
    <div class="field-row">
      <label for="start-date">èµ·å§‹æ—¥æœŸï¼š</label>
      <input type="date" id="start-date">
      <label for="end-date" style="margin-left: 12px;">çµæŸæ—¥æœŸï¼š</label>
      <input type="date" id="end-date">
      <button type="button" onclick="buildDays()">å»ºç«‹æ—¥æœŸåˆ—è¡¨</button>
    </div>
    <div class="field-row">
      <small>èªªæ˜ï¼šå…ˆé¸èµ·å§‹èˆ‡çµæŸæ—¥æœŸ â†’ æŒ‰ã€Œå»ºç«‹æ—¥æœŸåˆ—è¡¨ã€â†’ å‹¾é¸æ¯å¤©èª°æœ‰ä¸Šç­ï¼æ˜¯å¦ç¦ä¼‘ï¼æ˜¯å¦å¤§æ—¥ â†’ æŒ‰ã€Œç”¢ç”Ÿæ•´æ®µæ’ç­ã€ã€‚</small>
    </div>

    <div id="days-container" class="days-container"></div>

    <div class="field-row">
      <button type="button" id="generate-btn" onclick="generateSchedule()" disabled>
        ç”¢ç”Ÿæ•´æ®µæ’ç­
      </button>
      <button type="button" id="export-btn" onclick="exportExcel()" disabled>
        ä¸‹è¼‰ Excel
      </button>
    </div>
  </div>

  <div id="result-panel" class="result-panel" style="display:none;">
    <h2>æ’ç­çµæœ</h2>
    <div id="result-content"></div>
  </div>

  <div id="stats-panel" class="result-panel" style="display:none;">
    <h2>çµ±è¨ˆï¼ˆæ¯äºº A/B/C/D/Eã€â›°å¤§æ—¥ A/Dã€é€±ä¸€ C æ¬¡æ•¸ ï¼‹ å¤§æ—¥ A/D å·®ç•°ï¼†æ˜ç´°ï¼‰</h2>
    <div id="stats-content"></div>
  </div>

  <script>
    // å¾å¾Œç«¯å¸¶ä¾†çš„å“¡å·¥åå–®
    const EMPLOYEES = {{ employees | tojson | safe }};
    const weekdayMap = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];

    // ä¸Šä¸€æ¬¡ç”¢ç”Ÿçš„æ’ç­çµæœ + æ—¥æœŸç¯„åœï¼ˆçµ¦åŒ¯å‡ºç”¨ï¼‰
    window.lastSchedule = null;
    window.lastStartDate = "";
    window.lastEndDate = "";

    function parseDateInput(id) {
      const v = document.getElementById(id).value;
      if (!v) return null;
      return new Date(v + "T00:00:00");
    }

    function buildDays() {
      const start = parseDateInput("start-date");
      const end = parseDateInput("end-date");
      const container = document.getElementById("days-container");
      container.innerHTML = "";
      document.getElementById("result-panel").style.display = "none";
      document.getElementById("stats-panel").style.display = "none";
      document.getElementById("export-btn").disabled = true;
      window.lastSchedule = null;

      if (!start || !end) {
        alert("è«‹å…ˆé¸æ“‡èµ·å§‹èˆ‡çµæŸæ—¥æœŸã€‚");
        return;
      }
      if (end < start) {
        alert("çµæŸæ—¥æœŸä¸èƒ½æ—©æ–¼èµ·å§‹æ—¥æœŸã€‚");
        return;
      }

      let current = new Date(start.getTime());
      let index = 1;

      while (current <= end) {
        const y = current.getFullYear();
        const m = (current.getMonth() + 1).toString().padStart(2, "0");
        const d = current.getDate().toString().padStart(2, "0");
        const w = weekdayMap[current.getDay()];
        const dateStr = `${y}-${m}-${d}`;

        const block = document.createElement("div");
        block.className = "day-block";
        block.dataset.date = dateStr;

        const header = document.createElement("div");
        header.className = "day-header";
        header.innerHTML = `
          <span>Day ${index}ï½œ${dateStr}ï¼ˆé€±${w}ï¼‰</span>
          <div>
            <label style="margin-right: 10px;">
              <input type="checkbox" class="bigday-toggle">
              å¤§æ—¥
            </label>
            <label>
              <input type="checkbox" class="full-staff-toggle">
              ç¦ä¼‘æ—¥ï¼ˆå…¨å“¡ä¸Šç­ï¼‰
            </label>
          </div>
        `;
        block.appendChild(header);

        const empList = document.createElement("div");
        empList.className = "emp-list";

        EMPLOYEES.forEach(name => {
          const label = document.createElement("label");
          label.className = "emp-item";
          label.innerHTML = `
            <input type="checkbox" class="emp-checkbox" value="${name}">
            ${name}
          `;
          empList.appendChild(label);
        });

        block.appendChild(empList);
        container.appendChild(block);

        const fullToggle = block.querySelector(".full-staff-toggle");
        fullToggle.addEventListener("change", () => {
          const checkboxes = block.querySelectorAll(".emp-checkbox");
          checkboxes.forEach(cb => {
            cb.checked = fullToggle.checked;
          });
        });

        const empCheckboxes = block.querySelectorAll(".emp-checkbox");
        empCheckboxes.forEach(cb => {
          cb.addEventListener("change", () => {
            const allChecked = Array.from(empCheckboxes).every(x => x.checked);
            fullToggle.checked = allChecked;
          });
        });

        current.setDate(current.getDate() + 1);
        index++;
      }

      if (index > 1) {
        document.getElementById("generate-btn").disabled = false;
      } else {
        document.getElementById("generate-btn").disabled = true;
      }
    }

    async function generateSchedule() {
      const container = document.getElementById("days-container");
      const blocks = container.querySelectorAll(".day-block");
      if (!blocks.length) {
        alert("è«‹å…ˆå»ºç«‹æ—¥æœŸåˆ—è¡¨ã€‚");
        return;
      }

      const payloadDays = [];

      blocks.forEach(block => {
        const fullToggle = block.querySelector(".full-staff-toggle");
        const bigToggle = block.querySelector(".bigday-toggle");
        const empCheckboxes = block.querySelectorAll(".emp-checkbox");
        const dateStr = block.dataset.date;

        let emps = [];
        if (!fullToggle.checked) {
          empCheckboxes.forEach(cb => {
            if (cb.checked) emps.push(cb.value);
          });
        }

        payloadDays.push({
          date: dateStr,
          big_day: bigToggle.checked,
          full_staff: fullToggle.checked,
          employees: emps
        });
      });

      const resp = await fetch("/api/schedule_range", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ days: payloadDays })
      });

      const data = await resp.json();
      const panel = document.getElementById("result-panel");
      const content = document.getElementById("result-content");

      if (!resp.ok || data.error) {
        panel.style.display = "block";
        content.innerHTML = `<p style="color:red;">éŒ¯èª¤ï¼š${data.error || "æœªçŸ¥éŒ¯èª¤"}</p>`;
        document.getElementById("export-btn").disabled = true;
        document.getElementById("stats-panel").style.display = "none";
        return;
      }

      const schedule = data.schedule || [];
      window.lastSchedule = schedule;
      window.lastStartDate = document.getElementById("start-date").value;
      window.lastEndDate = document.getElementById("end-date").value;
      document.getElementById("export-btn").disabled = schedule.length === 0;

      let html = "";
      schedule.forEach(day => {
        html += `<div class="result-day">`;
        const dateLabel = day.date ? `ï½œ${day.date}` : "";
        const bigLabel = day.big_day ? "ï¼ˆå¤§æ—¥ï¼‰" : "";
        html += `<h3>Day ${day.day_index}${dateLabel}${bigLabel}</h3>`;
        html += `<pre>`;
        for (const [name, pos] of Object.entries(day.assignment)) {
          html += `${name}ï¼š${pos}\n`;
        }
        html += `</pre>`;
        html += `</div>`;
      });

      panel.style.display = "block";
      content.innerHTML = html;

      // ç”¢ç”Ÿçµ±è¨ˆè¡¨ + å¤§æ—¥A/Då·®ç•°
      renderStats(schedule);
    }

    function renderStats(schedule) {
      const panel = document.getElementById("stats-panel");
      const content = document.getElementById("stats-content");

      if (!schedule || !schedule.length) {
        panel.style.display = "none";
        content.innerHTML = "";
        return;
      }

      // åˆå§‹åŒ–çµ±è¨ˆ & å¤§æ—¥A/Dæ—¥æœŸç´€éŒ„
      const stats = {};
      const bigDDays = {}; // è¨˜éŒ„æ¯å€‹äºº å¤§æ—¥D æ˜¯å“ªå¹¾å¤©
      const bigADays = {}; // è¨˜éŒ„æ¯å€‹äºº å¤§æ—¥A æ˜¯å“ªå¹¾å¤©

      EMPLOYEES.forEach(name => {
        stats[name] = {
          total: 0,
          A: 0,
          B: 0,
          C: 0,
          D: 0,
          E: 0,
          bigA: 0,
          bigD: 0,
          monC: 0,
        };
        bigDDays[name] = [];
        bigADays[name] = [];
      });

      schedule.forEach(day => {
        const dateStr = day.date;
        const isBig = !!day.big_day;

        let weekday = null; // 0=æ—¥,1=ä¸€,...6=å…­
        if (dateStr) {
          const d = new Date(dateStr + "T00:00:00");
          if (!isNaN(d.getTime())) {
            weekday = d.getDay();
          }
        }

        for (const [name, role] of Object.entries(day.assignment)) {
          if (!stats[name]) {
            stats[name] = {
              total: 0,
              A: 0, B: 0, C: 0, D: 0, E: 0,
              bigA: 0, bigD: 0, monC: 0,
            };
          }
          if (!bigDDays[name]) {
            bigDDays[name] = [];
          }
          if (!bigADays[name]) {
            bigADays[name] = [];
          }

          stats[name].total += 1;
          if (stats[name][role] !== undefined) {
            stats[name][role] += 1;
          }

          if (isBig && role === "A") {
            stats[name].bigA += 1;
            const labelA = dateStr ? dateStr : `Day ${day.day_index}`;
            bigADays[name].push(labelA);
          }
          if (isBig && role === "D") {
            stats[name].bigD += 1;
            const labelD = dateStr ? dateStr : `Day ${day.day_index}`;
            bigDDays[name].push(labelD);
          }
          // JS çš„ Monday = 1
          if (weekday === 1 && role === "C" && name !== "åœ¨æ…¶" && name !== "å¥•å¿ ") {
            stats[name].monC += 1;
          }
        }
      });

      const names = Object.keys(stats).sort((a, b) =>
        a.localeCompare(b, "zh-Hant")
      );

      let html = "<table><thead><tr>";
      html += "<th>äººå“¡</th>";
      html += "<th>ç¸½ç­æ•¸</th>";
      html += "<th>A</th><th>B</th><th>C</th><th>D</th><th>E</th>";
      html += "<th>å¤§æ—¥ A</th><th>å¤§æ—¥ D</th><th>é€±ä¸€ C</th>";
      html += "</tr></thead><tbody>";

      names.forEach(name => {
        const s = stats[name];
        html += "<tr>";
        html += `<td>${name}</td>`;
        html += `<td>${s.total}</td>`;
        html += `<td>${s.A}</td>`;
        html += `<td>${s.B}</td>`;
        html += `<td>${s.C}</td>`;
        html += `<td>${s.D}</td>`;
        html += `<td>${s.E}</td>`;
        html += `<td>${s.bigA}</td>`;
        html += `<td>${s.bigD}</td>`;
        html += `<td>${s.monC}</td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";

      // ===== å¤§æ—¥ A å·®ç•°çµ±è¨ˆ =====
      let totalBigA = 0;
      names.forEach(name => {
        totalBigA += stats[name].bigA;
      });
      const avgBigA = names.length ? (totalBigA / names.length) : 0;

      html += "<h3>â›° å¤§æ—¥ A å¹³è¡¡æª¢è¦–</h3>";
      html += "<table><thead><tr>";
      html += "<th>äººå“¡</th><th>å¤§æ—¥ A æ¬¡æ•¸</th><th>èˆ‡å¹³å‡å·®ç•°</th>";
      html += "</tr></thead><tbody>";

      names.forEach(name => {
        const countA = stats[name].bigA;
        const diffA = (countA - avgBigA).toFixed(2);
        html += "<tr>";
        html += `<td>${name}</td>`;
        html += `<td>${countA}</td>`;
        html += `<td>${diffA}</td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";

      // ===== å¤§æ—¥ A è©³ç´°æ—¥æœŸ =====
      html += "<h3>ğŸ“… å„äººã€Œå¤§æ—¥ Aã€æ—¥æœŸæ˜ç´°</h3>";
      names.forEach(name => {
        const daysA = bigADays[name];
        const lineA = daysA.length ? daysA.join("ã€") : "ï¼ˆæœ¬æœŸç„¡å¤§æ—¥ Aï¼‰";
        html += `<p>${name}ï¼š${lineA}</p>`;
      });

      // ===== å¤§æ—¥ D å·®ç•°çµ±è¨ˆ =====
      let totalBigD = 0;
      names.forEach(name => {
        totalBigD += stats[name].bigD;
      });
      const avgBigD = names.length ? (totalBigD / names.length) : 0;

      html += "<h3>â›° å¤§æ—¥ D å¹³è¡¡æª¢è¦–</h3>";
      html += "<table><thead><tr>";
      html += "<th>äººå“¡</th><th>å¤§æ—¥ D æ¬¡æ•¸</th><th>èˆ‡å¹³å‡å·®ç•°</th>";
      html += "</tr></thead><tbody>";

      names.forEach(name => {
        const countD = stats[name].bigD;
        const diffD = (countD - avgBigD).toFixed(2);
        html += "<tr>";
        html += `<td>${name}</td>`;
        html += `<td>${countD}</td>`;
        html += `<td>${diffD}</td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";

      // ===== å¤§æ—¥ D è©³ç´°æ—¥æœŸ =====
      html += "<h3>ğŸ“… å„äººã€Œå¤§æ—¥ Dã€æ—¥æœŸæ˜ç´°</h3>";
      names.forEach(name => {
        const daysD = bigDDays[name];
        const lineD = daysD.length ? daysD.join("ã€") : "ï¼ˆæœ¬æœŸç„¡å¤§æ—¥ Dï¼‰";
        html += `<p>${name}ï¼š${lineD}</p>`;
      });

      content.innerHTML = html;
      panel.style.display = "block";
    }

    async function exportExcel() {
      if (!window.lastSchedule || !window.lastSchedule.length) {
        alert("è«‹å…ˆç”¢ç”Ÿæ’ç­ï¼Œå†ä¸‹è¼‰ Excelã€‚");
        return;
      }

      const startDate = window.lastStartDate || document.getElementById("start-date").value;
      const endDate = window.lastEndDate || document.getElementById("end-date").value;

      const resp = await fetch("/api/export_excel", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          schedule: window.lastSchedule,
          start_date: startDate,
          end_date: endDate
        })
      });

      if (!resp.ok) {
        alert("ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
        return;
      }

      const blob = await resp.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "";  // æª”åç”±å¾Œç«¯ headers æ§åˆ¶
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
